FROM node:10

WORKDIR /app

# Set NODE_ENV to production to avoid installing any dependencies that aren't
# necessary for the build
ENV NODE_ENV=production

# Install envkey-source to make environment available for sequelize migration
RUN curl -s -L -o envkey-source.tar.gz https://github.com/envkey/envkey-source/releases/download/v1.2.5/envkey-source_1.2.5_linux_amd64.tar.gz
RUN tar -zxf envkey-source.tar.gz 2> /dev/null
RUN rm envkey-source.tar.gz
RUN mv envkey-source /usr/local/bin

COPY package*.json ./
COPY lerna.json ./
COPY ./origin-js ./origin-js
COPY ./origin-contracts ./origin-contracts
COPY ./origin-discovery ./origin-discovery
COPY ./scripts ./scripts

RUN npm install --unsafe-perm

COPY ./origin-contracts/releases/0.8.4/build/ ./origin-contracts/build/

# Workaround for hoist incompatible modules
RUN ln -s ../../node_modules/scrypt origin-js/node_modules/scrypt
RUN ln -s ../../node_modules/got origin-js/node_modules/got

# Build origin-js so it is available for the event-listener to import
RUN npm run build --prefix origin-js

CMD eval $(envkey-source) && \
	npm run migrate --prefix origin-discovery && \
	npm run start:listener --prefix origin-discovery
